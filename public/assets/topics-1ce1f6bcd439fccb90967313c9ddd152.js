!function(){window.Topics={replies_per_page:50,appendImageFromUpload:function(e){var t,o,a,r,i,n,l,c;for(n=$(".topic_editor"),o=n.caret("pos"),i="",l=0,c=e.length;c>l;l++)r=e[l],i="![]("+r+")\n";return a=n.val(),t=a.slice(0,o),n.val(t+i+a.slice(o+1,a.count)),n.caret("pos",o+i.length),n.focus()},initUploader:function(){var e;return $("#topic_add_image").bind("click",function(){return $(".topic_editor").focus(),$("#topic_upload_images").click(),!1}),e={url:"/photos",type:"POST",beforeSend:function(){return $("#topic_add_image").hide(),$("#topic_add_image").before("<span class='loading'>上传中...</span>")},success:function(e){return $("#topic_add_image").parent().find("span.loading").remove(),$("#topic_add_image").show(),Topics.appendImageFromUpload([e])}},$("#topic_upload_images").fileUpload(e),!1},reply:function(e,t){var o,a;return a=$("#reply_body"),o="#"+e+"楼 @"+t+" ",0===a.val().trim().length?o+="":o="\n"+o,a.focus().val(a.val()+o),!1},pageOfFloor:function(e){return Math.floor((e-1)/Topics.replies_per_page)+1},gotoFloor:function(e){var t,o,a;return o=$("#reply"+e),o.length>0?Topics.highlightReply(o):(t=Topics.pageOfFloor(e),a=window.location.pathname+("?page="+t)+("#reply"+e),App.gotoUrl(a)),o},highlightReply:function(e){return $("#replies .reply").removeClass("light"),e.addClass("light")},checkRepliesLikeStatus:function(e){var t,o,a,r,i;for(i=[],a=0,r=e.length;r>a;a++)o=e[a],t=$("#replies a.likeable[data-id="+o+"]"),i.push(App.likeableAsLiked(t));return i},replyCallback:function(e,t){return $("#main .alert-message").remove(),e?($("abbr.timeago",$("#replies .reply").last()).timeago(),$("abbr.timeago",$("#replies .total")).timeago(),$("#new_reply textarea").val(""),$("#preview").text(""),App.notice(t,"#reply")):App.alert(t,"#reply"),$("#new_reply textarea").focus(),$("#btn_reply").button("reset")},preview:function(e){return $("#preview").text("Loading..."),$.post("/topics/preview",{body:e},function(e){return $("#preview").html(e.body)},"json")},hookPreview:function(e,t){var o;return o=$(document.createElement("div")).attr("id","preview"),o.addClass("markdown_body"),$(t).after(o),o.hide(),$(".edit a",e).click(function(){return $(".preview",e).removeClass("active"),$(this).parent().addClass("active"),$(o).hide(),$(t).show(),!1}),$(".preview a",e).click(function(){return $(".edit",e).removeClass("active"),$(this).parent().addClass("active"),$(o).show(),$(t).hide(),Topics.preview($(t).val()),!1})},initCloseWarning:function(e,t){return 0===e.length?!1:(t||(t="离开本页面将丢失未保存页面!"),$("input[type=submit]").click(function(){return $(window).unbind("beforeunload")}),e.change(function(){return e.val().length>0?$(window).bind("beforeunload",function(e){return $.browser.msie?e.returnValue=t:t}):$(window).unbind("beforeunload")}))},favorite:function(e){var t,o;return o=$(e).data("id"),$(e).hasClass("small_bookmarked")?(t={type:"unfavorite"},$.ajax({url:"/topics/"+o+"/favorite",data:t,type:"POST"}),$(e).attr("title","收藏"),$(e).attr("class","icon small_bookmark")):($.post("/topics/"+o+"/favorite"),$(e).attr("title","取消收藏"),$(e).attr("class","icon small_bookmarked")),!1},follow:function(e){var t,o;return o=$(e).data("id"),t=$(e).data("followed"),t?($.ajax({url:"/topics/"+o+"/unfollow",type:"POST"}),$(e).data("followed",!1),$("i",e).attr("class","icon small_follow")):($.ajax({url:"/topics/"+o+"/follow",type:"POST"}),$(e).data("followed",!0),$("i",e).attr("class","icon small_followed")),!1},submitTextArea:function(e){return $(e.target).val().trim().length>0&&$("#reply > form").submit(),!1},appendCodesFromHint:function(e){var t,o,a,r,i,n;return null==e&&(e=""),n=$(".topic_editor"),o=n.caret("pos"),a="",n.val().length>0&&(a="\n"),i=""+a+"```"+e+"\n\n```\n",r=n.val(),t=r.slice(0,o),n.val(t+i+r.slice(o+1,r.count)),n.caret("pos",o+i.length-5),n.focus()},init:function(){var e,t,o,a,r;return e=$("body"),Topics.initCloseWarning($("textarea.closewarning")),$("textarea").bind("keydown","ctrl+return",function(e){return Topics.submitTextArea(e)}),$("textarea").bind("keydown","Meta+return",function(e){return Topics.submitTextArea(e)}),$("textarea").autogrow(),Topics.initUploader(),$("a.at_floor").on("click",function(){var e;return e=$(this).data("floor"),Topics.gotoFloor(e)}),a=window.location.hash.match(/^#reply(\d+)$/),null!=a&&Topics.highlightReply($("#reply"+a[1])),$("a.small_reply").on("click",function(){return Topics.reply($(this).data("floor"),$(this).attr("data-login"))}),Topics.hookPreview($(".editor_toolbar"),$(".topic_editor")),$("a.insert_code").on("click",function(){return Topics.appendCodesFromHint($(this).data("content")||$(this).attr("id"))}),e.bind("keydown","m",function(){return $("#markdown_help_tip_modal").modal({keyboard:!0,backdrop:!0,show:!0})}),o=App.scanLogins($("#topic_show .leader a[data-author]")),$.extend(o,App.scanLogins($("#replies span.name a"))),o=function(){var e;e=[];for(t in o)r=o[t],e.push({login:t,name:r,search:""+t+" "+r});return e}(),App.atReplyable("textarea",o),$("body.topics-controller.new-action #topic_title").focus()}},$(document).ready(function(){var e;return"topics"===(e=$("body").data("controller-name"))||"replies"===e?Topics.init():void 0})}.call(this);